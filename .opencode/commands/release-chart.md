--- 
name: release-chart
description: Releases a new version of a Helm chart with semantic version bump
usage: /release-chart [chart_name] [version_type]
parameters:
  - name: chart_name
    type: string 
    required: false
    description: Name of the chart to release (default: fdp)
  - name: version_type
    type: string
    required: false
    description: Type of version bump (patch, minor, major). If not provided, will prompt user.
examples:
  - "/release-chart fdp major"
  - "/release-chart"
  - "/release-chart fdp patch"
---

# Helm Chart Release Slash Command

## Command Logic

This command handles the complete Helm chart release workflow:

### 1. Branch Validation
- Checks current git branch
- Confirms release intent if not on main branch
- Prevents accidental releases from feature branches

### 2. Chart Selection
- Defaults to 'fdp' chart if none specified
- Validates chart exists in charts/ directory
- Reads current version from Chart.yaml

### 3. Version Bump Selection
- Prompts for version type if not provided
- Supports semantic versioning (patch, minor, major)
- Validates input and confirms before proceeding

### 4. Version Update
- Parses current version from Chart.yaml
- Calculates new version based on selected bump type
- Updates Chart.yaml with new version
- Updates appVersion if needed

### 5. Commit and Push
- Creates commit with release information
- Pushes changes to remote
- Tags the release if on main branch

## Semantic Versioning Rules

- **patch**: Backward-compatible bug fixes (0.1.8 â†’ 0.1.9)
- **minor**: Backward-compatible new features (0.1.8 â†’ 0.2.0)
- **major**: Breaking changes (0.1.8 â†’ 1.0.0)

## Implementation

The implementation follows the logic described above. The command is designed to be safe and provide clear feedback at each step of the process.
#!/bin/bash

# Slash Command: release-chart
# Auto-generated by opencode from MD specification

set -e  # Exit on error

# Function to parse semantic version
parse_version() {
    local version=$1
    # Extract major, minor, patch
    if [[ $version =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
        echo "${BASH_REMATCH[1]} ${BASH_REMATCH[2]} ${BASH_REMATCH[3]}"
    else
        echo "0 0 0"  # Default if parsing fails
    fi
}

# Function to bump version
bump_version() {
    local version=$1
    local bump_type=$2
    
    local parts=($version)
    local major=${parts[0]}
    local minor=${parts[1]}
    local patch=${parts[2]}
    
    case $bump_type in
        major)
            major=$((major + 1))
            minor=0
            patch=0
            ;;
        minor)
            minor=$((minor + 1))
            patch=0
            ;;
        patch)
            patch=$((patch + 1))
            ;;
        *)
            echo "Invalid bump type: $bump_type" >&2
            return 1
            ;;
    esac
    
    echo "${major}.${minor}.${patch}"
}

# Function to confirm action
confirm_action() {
    local message=$1
    read -p "$message (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        return 0
    else
        return 1
    fi
}

# Main execution
echo "=== Helm Chart Release Command ==="
echo

# Check if we're in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "âŒ Error: Not in a git repository"
    exit 1
fi

# Get current branch
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
if [ -z "$CURRENT_BRANCH" ]; then
    echo "âŒ Error: Not on any branch (detached HEAD)"
    exit 1
fi

echo "ğŸ“ Repository: $(basename $(git rev-parse --show-toplevel))"
echo "ğŸŒ¿ Current branch: $CURRENT_BRANCH"
echo

# Check if we're on main branch
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo "âš ï¸  You are not on the main branch"
    echo "ğŸ’¡ Releases are typically created from the main branch"
    if ! confirm_action "Do you want to continue with the release anyway?"; then
        echo "ğŸ”´ Release cancelled"
        exit 0
    fi
    echo
fi

# Get chart name (default to fdp)
CHART_NAME="${1:-fdp}"
CHART_PATH="charts/$CHART_NAME"

# Validate chart exists
if [ ! -d "$CHART_PATH" ]; then
    echo "âŒ Error: Chart '$CHART_NAME' not found in charts/ directory"
    ls -la charts/ 2>/dev/null || echo "ğŸ“ charts/ directory not found"
    exit 1
fi

# Check Chart.yaml exists
CHART_YAML="$CHART_PATH/Chart.yaml"
if [ ! -f "$CHART_YAML" ]; then
    echo "âŒ Error: Chart.yaml not found in $CHART_PATH/"
    exit 1
fi

echo "ğŸ“¦ Chart: $CHART_NAME"

# Read current version
CURRENT_VERSION=$(grep "^version:" "$CHART_YAML" | awk '{print $2}' | trim)
if [ -z "$CURRENT_VERSION" ]; then
    echo "âŒ Error: Could not read current version from Chart.yaml"
    exit 1
fi

echo "ğŸ·ï¸  Current version: $CURRENT_VERSION"

# Get version bump type
VERSION_BUMP="${2:-}"

if [ -z "$VERSION_BUMP" ]; then
    echo
    echo "ğŸ“ˆ Select version bump type:"
    echo "  1) patch   - Backward-compatible bug fixes (0.1.8 â†’ 0.1.9)"
    echo "  2) minor   - Backward-compatible new features (0.1.8 â†’ 0.2.0)"
    echo "  3) major   - Breaking changes (0.1.8 â†’ 1.0.0)"
    echo
    
    while true; do
        read -p "Enter version bump type (patch/minor/major): " -r VERSION_BUMP
        if [[ "$VERSION_BUMP" =~ ^(patch|minor|major)$ ]]; then
            break
        else
            echo "âŒ Invalid input. Please enter 'patch', 'minor', or 'major'."
        fi
    done
fi

echo

# Calculate new version
NEW_VERSION=$(bump_version "$CURRENT_VERSION" "$VERSION_BUMP")
if [ $? -ne 0 ]; then
    echo "âŒ Error: Failed to calculate new version"
    exit 1
fi

echo "ğŸ†• New version: $NEW_VERSION"
echo

# Confirm before proceeding
if ! confirm_action "Are you sure you want to release $CHART_NAME version $NEW_VERSION?"; then
    echo "ğŸ”´ Release cancelled"
    exit 0
fi

echo

# Update Chart.yaml
echo "ğŸ“ Updating Chart.yaml..."

# Backup original file
cp "$CHART_YAML" "$CHART_YAML.bak"

# Update version
sed -i '' "s/^version: .*/version: $NEW_VERSION/" "$CHART_YAML"

# Check if sed command worked (macOS vs Linux compatibility)
if [ $? -ne 0 ]; then
    # Try alternative sed syntax for Linux
    sed -i "s/^version: .*/version: $NEW_VERSION/" "$CHART_YAML"
fi

# Verify the change
UPDATED_VERSION=$(grep "^version:" "$CHART_YAML" | awk '{print $2}')
if [ "$UPDATED_VERSION" != "$NEW_VERSION" ]; then
    echo "âŒ Error: Failed to update version in Chart.yaml"
    mv "$CHART_YAML.bak" "$CHART_YAML"
    exit 1
fi

echo "âœ… Chart.yaml updated successfully"

# Clean up backup
rm "$CHART_YAML.bak"

# Show the changes
echo
echo "ğŸ“‹ Changes made:"
git diff "$CHART_YAML"
echo

# Create commit message
COMMIT_MESSAGE="ğŸ“¦ Release $CHART_NAME v$NEW_VERSION"

# Add appVersion update if it exists
APP_VERSION=$(grep "^appVersion:" "$CHART_YAML" | awk '{print $2}' | sed 's/"//g')
if [ -n "$APP_VERSION" ]; then
    COMMIT_MESSAGE="$COMMIT_MESSAGE\n\n- Chart version: $CURRENT_VERSION â†’ $NEW_VERSION"
    COMMIT_MESSAGE="$COMMIT_MESSAGE\n- App version: $APP_VERSION"
else
    COMMIT_MESSAGE="$COMMIT_MESSAGE\n\n- Version: $CURRENT_VERSION â†’ $NEW_VERSION"
fi

# Stage changes
echo "ğŸ“¦ Staging changes..."
git add "$CHART_YAML"
echo "âœ… Changes staged"

# Create commit
echo "ğŸ’¾ Creating release commit..."
if git commit -m "$COMMIT_MESSAGE"; then
    echo "âœ… Commit created successfully"
else
    echo "âŒ Error: Failed to create commit"
    exit 1
fi

# Create tag if on main branch
if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "ğŸ·ï¸  Creating git tag..."
    TAG_NAME="$CHART_NAME-v$NEW_VERSION"
    if git tag "$TAG_NAME"; then
        echo "âœ… Tag created: $TAG_NAME"
    else
        echo "âš ï¸  Warning: Failed to create tag"
    fi
fi

# Push changes
echo "ğŸ”„ Checking upstream configuration..."
UPSTREAM=$(git rev-parse --abbrev-ref "$CURRENT_BRANCH"@{upstream} 2>/dev/null)

if [ -n "$UPSTREAM" ]; then
    echo "ğŸ“¡ Upstream found: $UPSTREAM"
    echo "ğŸš€ Pushing changes..."
    if git push; then
        echo "âœ… Push successful!"
        
        # Push tags if on main branch
        if [ "$CURRENT_BRANCH" = "main" ]; then
            echo "ğŸ·ï¸  Pushing tags..."
            git push --tags
            echo "âœ… Tags pushed successfully"
        fi
    else
        echo "âŒ Error: Push failed"
        exit 1
    fi
else
    echo "âš ï¸  No upstream configured for branch $CURRENT_BRANCH"
    echo "ğŸ’¡ To set upstream, run: git push --set-upstream origin $CURRENT_BRANCH"
fi

echo
echo "ğŸ‰ Helm chart release completed successfully!"
echo "ğŸ“¦ Chart: $CHART_NAME"
echo "ğŸ·ï¸  Version: $NEW_VERSION"
echo

# Provide next steps
if [ "$CURRENT_BRANCH" = "main" ]; then
    echo "ğŸ’¡ Next steps:"
    echo "  - helm package charts/$CHART_NAME/"
    echo "  - helm push $CHART_NAME-$NEW_VERSION.tgz your-repo"
    echo "  - Update release notes"
    echo "  - Create GitHub release for tag $CHART_NAME-v$NEW_VERSION"
else
    echo "ğŸ’¡ Remember to merge this release to main branch when ready"
fi